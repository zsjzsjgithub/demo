{"remainingRequest":"/www/admin/node_modules/thread-loader/dist/cjs.js!/www/admin/node_modules/babel-loader/lib/index.js!/www/admin/src/ws.js","dependencies":[{"path":"/www/admin/src/ws.js","mtime":1565340815000},{"path":"/www/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/www/admin/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/www/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _JSON$stringify from \"/www/admin/node_modules/@babel/runtime-corejs2/core-js/json/stringify\";\nimport _typeof from \"/www/admin/node_modules/@babel/runtime-corejs2/helpers/esm/typeof\";\nimport store from './store';\nimport { MessageBox } from 'element-ui';\nvar ws = {\n  ws: null,\n  needTip: false,\n  host: process.env.VUE_APP_WS_HOST,\n  si: null,\n  retry: 0,\n  init: function init(r) {\n    if (this.ws === null || r) {\n      this.needTip = true;\n      this.ws = new WebSocket(this.host);\n      this.ws.onopen = event.onOpen;\n      this.ws.onclose = event.onClose;\n      this.ws.onmessage = event.onMessage;\n      this.ws.onerror = event.onError;\n    }\n  },\n  close: function close() {\n    if (this.ws !== null) {\n      this.needTip = false;\n      this.ws.close();\n    }\n  },\n  send: function send(data) {\n    if (_typeof(data) === 'object') {\n      data = _JSON$stringify(data);\n    }\n\n    this.ws.send(data);\n  }\n};\nvar event = {\n  onOpen: function onOpen() {\n    if (store.state.token) {\n      ws.send({\n        action: 'login',\n        type: 0,\n        token: store.state.token.token\n      });\n    }\n\n    if (ws.retry > 0) {\n      ws.retry = 0;\n      console.info('%c重连成功', 'color: green');\n    } // 发送心跳，保持连接\n\n\n    ws.si = setInterval(function () {\n      ws.send({\n        heartbeat: true\n      });\n    }, 50000);\n  },\n  onClose: function onClose() {\n    if (ws.needTip === true) {\n      if (ws.retry >= 10) {\n        MessageBox.alert('服务器连接失败，请稍后刷新页面再试！', '服务端错误', {\n          confirmButtonText: '刷新',\n          type: 'error',\n          showClose: false,\n          closeOnHashChange: false,\n          callback: function callback() {\n            global.location.reload();\n          }\n        });\n      } else {\n        console.log(\"3\\u79D2\\u540E\\u8FDB\\u884C\\u7B2C\".concat(++ws.retry, \"\\u6B21\\u91CD\\u8FDE\"));\n        setTimeout(function () {\n          ws.init(true);\n        }, 3000);\n      }\n    } else {\n      ws.ws = null;\n    }\n\n    clearInterval(ws.si);\n  },\n  onMessage: function onMessage(_ref) {\n    var data = _ref.data;\n    var res = JSON.parse(data);\n\n    if (res.hasOwnProperty('action')) {\n      if (res.action === 'topdata') {\n        // 顶部统计\n        delete res.action;\n        store.commit('saveTopData', res);\n      }\n    }\n  },\n  onError: function onError() {\n    console.error('WS Error');\n  }\n};\nexport default ws;",{"version":3,"sources":["/www/admin/src/ws.js"],"names":["store","MessageBox","ws","needTip","host","process","env","VUE_APP_WS_HOST","si","retry","init","r","WebSocket","onopen","event","onOpen","onclose","onClose","onmessage","onMessage","onerror","onError","close","send","data","state","token","action","type","console","info","setInterval","heartbeat","alert","confirmButtonText","showClose","closeOnHashChange","callback","global","location","reload","log","setTimeout","clearInterval","res","JSON","parse","hasOwnProperty","commit","error"],"mappings":"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","sourcesContent":["import store from './store'\nimport {MessageBox} from 'element-ui'\n\nconst ws = {\n  ws: null,\n  needTip: false,\n  host: process.env.VUE_APP_WS_HOST,\n  si: null,\n  retry: 0,\n  init(r) {\n    if (this.ws === null || r) {\n      this.needTip = true\n      this.ws = new WebSocket(this.host);\n      this.ws.onopen = event.onOpen\n      this.ws.onclose = event.onClose\n      this.ws.onmessage = event.onMessage\n      this.ws.onerror = event.onError\n    }\n  },\n  close() {\n    if (this.ws !== null) {\n      this.needTip = false\n      this.ws.close();\n    }\n  },\n  send(data) {\n    if (typeof data === 'object') {\n      data = JSON.stringify(data)\n    }\n    this.ws.send(data);\n  }\n}\n\nconst event = {\n  onOpen() {\n    if (store.state.token) {\n      ws.send({action: 'login', type: 0, token: store.state.token.token})\n    }\n    if (ws.retry > 0) {\n      ws.retry = 0\n      console.info('%c重连成功', 'color: green')\n    }\n    // 发送心跳，保持连接\n    ws.si = setInterval(() => {\n      ws.send({heartbeat: true})\n    }, 50000)\n  },\n  onClose() {\n    if (ws.needTip === true) {\n      if (ws.retry >= 10) {\n        MessageBox.alert('服务器连接失败，请稍后刷新页面再试！', '服务端错误', {\n          confirmButtonText: '刷新',\n          type: 'error',\n          showClose: false,\n          closeOnHashChange: false,\n          callback: () => {\n            global.location.reload()\n          }\n        })\n      } else {\n        console.log(`3秒后进行第${++ws.retry}次重连`)\n        setTimeout(() => {\n          ws.init(true)\n        }, 3000)\n      }\n    } else {\n      ws.ws = null\n    }\n\n    clearInterval(ws.si)\n  },\n  onMessage({data}) {\n    let res = JSON.parse(data);\n\n    if (res.hasOwnProperty('action')) {\n      if (res.action === 'topdata') {\n        // 顶部统计\n        delete res.action\n        store.commit('saveTopData', res)\n      }\n    }\n  },\n  onError() {\n    console.error('WS Error')\n  }\n}\n\nexport default ws"]}]}