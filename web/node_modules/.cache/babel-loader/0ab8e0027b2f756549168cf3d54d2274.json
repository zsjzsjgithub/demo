{"remainingRequest":"/www/web/node_modules/thread-loader/dist/cjs.js!/www/web/node_modules/babel-loader/lib/index.js!/www/web/src/axios.js","dependencies":[{"path":"/www/web/src/axios.js","mtime":1560668899000},{"path":"/www/web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/www/web/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/www/web/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _Message2 from \"element-ui/lib/theme-chalk/message.css\";\nimport \"element-ui/lib/theme-chalk/base.css\";\nimport _Message from \"element-ui/lib/message\";\nimport _Promise from \"/www/web/node_modules/@babel/runtime-corejs2/core-js/promise\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _JSON$stringify from \"/www/web/node_modules/@babel/runtime-corejs2/core-js/json/stringify\";\nimport _Loading2 from \"element-ui/lib/theme-chalk/loading.css\";\nimport \"element-ui/lib/theme-chalk/base.css\";\nimport _Loading from \"element-ui/lib/loading\";\nimport \"core-js/modules/es7.array.includes\";\nimport api from 'axios';\nimport store from './store';\nimport router from './router';\nimport i18n from './i18n';\napi.defaults.baseURL = process.env.VUE_APP_API_HOST;\nvar isRefreshing = false; // 是否正在刷新token，标记以避免重复刷新\n\nvar requests = []; // 需要刷新token的请求列表\n\nvar loading;\nvar noLoading = [// 不显示loading的请求\n'/tokens', '/tokens/info', '/trades'];\napi.interceptors.request.use(function (config) {\n  config.headers['Accept-Language'] = store.state.lang;\n\n  if (!noLoading.includes(config.url)) {\n    loading = _Loading.service({\n      fullscreen: true,\n      lock: true\n    });\n  }\n\n  var token = store.state.token;\n\n  if (token) {\n    var now = new Date().getTime() / 1000; // 判断是否需要刷新token\n\n    if (config.url !== '/tokens' && now >= token.expired_at) {\n      // 刷新token，防止多个连接并发\n      if (!isRefreshing) {\n        isRefreshing = true;\n        api.request({\n          url: '/tokens',\n          method: 'put',\n          headers: {\n            Authorization: token.type + ' ' + token.token\n          }\n        }).then(function (res) {\n          var newToken = null;\n\n          if (res) {\n            newToken = {\n              token: res.token,\n              type: res.type,\n              expired_at: res.expired_at\n            };\n            localStorage.JWT_FXHOS_TOKEN = _JSON$stringify(newToken);\n            store.commit('saveToken', newToken);\n          }\n\n          requests.forEach(function (requestItem) {\n            var resolve = requestItem.resolve,\n                conf = requestItem.conf;\n\n            if (newToken) {\n              conf.headers['Authorization'] = newToken.type + ' ' + newToken.token;\n            }\n\n            resolve(conf);\n          });\n          requests = [];\n          isRefreshing = false;\n        });\n      } // 收集需要刷新token的请求，待token刷新完毕时resolve触发\n\n\n      return new _Promise(function (resolve) {\n        requests.push({\n          resolve: resolve,\n          conf: config\n        });\n      });\n    } // 无需刷新的token直接设置并返回\n\n\n    config.headers['Authorization'] = token.type + ' ' + token.token;\n  }\n\n  return config;\n}, function (error) {\n  loading && loading.close(); // 对请求错误做些什么\n\n  return _Promise.reject(error);\n});\napi.interceptors.response.use(function (res) {\n  loading && loading.close();\n  var data = res.data;\n\n  if (data.code !== 200) {\n    if (data.code === 401) {\n      _Message.error('登录超时，请重新登录');\n\n      localStorage.removeItem('JWT_FXHOS_TOKEN');\n      global.location.reload();\n    } else if (data.code === 404) {\n      router.push('/404');\n    } else if (data.code === 422) {\n      for (var key in data.data) {\n        var err = data.data[key];\n        if (typeof err === 'string') _Message.error(err);else _Message.error(err[0]);\n        break;\n      }\n    } else if (data.code === 500 && typeof data.data === 'string') {\n      _Message.error(data.data);\n    } else {\n      _Message.error(i18n.t('base.error'));\n    }\n  } else {\n    loading && loading.close();\n    return data.data || true;\n  }\n});\nexport default {\n  install: function install(Vue) {\n    Vue.api = api;\n    Vue.prototype.$api = api;\n  }\n};",{"version":3,"sources":["/www/web/src/axios.js"],"names":["api","store","router","i18n","defaults","baseURL","process","env","VUE_APP_API_HOST","isRefreshing","requests","loading","noLoading","interceptors","request","use","config","headers","state","lang","includes","url","service","fullscreen","lock","token","now","Date","getTime","expired_at","method","Authorization","type","then","res","newToken","localStorage","JWT_FXHOS_TOKEN","commit","forEach","requestItem","resolve","conf","push","error","close","reject","response","data","code","removeItem","global","location","reload","key","err","t","install","Vue","prototype","$api"],"mappings":"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","sourcesContent":["import api from 'axios'\nimport store from './store'\nimport router from './router'\nimport {Loading, Message} from 'element-ui'\nimport i18n from './i18n'\n\napi.defaults.baseURL = process.env.VUE_APP_API_HOST\n\nlet isRefreshing = false // 是否正在刷新token，标记以避免重复刷新\nlet requests = [] // 需要刷新token的请求列表\nlet loading\nconst noLoading = [ // 不显示loading的请求\n  '/tokens',\n  '/tokens/info',\n  '/trades'\n]\napi.interceptors.request.use(config => {\n  config.headers['Accept-Language'] = store.state.lang\n  if (!noLoading.includes(config.url)) {\n    loading = Loading.service({\n      fullscreen: true,\n      lock: true\n    })\n  }\n  let token = store.state.token\n  if (token) {\n    let now = new Date().getTime() / 1000\n\n    // 判断是否需要刷新token\n    if (config.url !== '/tokens' && now >= token.expired_at) {\n      // 刷新token，防止多个连接并发\n      if (!isRefreshing) {\n        isRefreshing = true\n        api.request({\n          url: '/tokens',\n          method: 'put',\n          headers: {Authorization: token.type + ' ' + token.token}\n        }).then(res => {\n          let newToken = null\n          if (res) {\n            newToken = {\n              token: res.token,\n              type: res.type,\n              expired_at: res.expired_at\n            }\n            localStorage.JWT_FXHOS_TOKEN = JSON.stringify(newToken)\n            store.commit('saveToken', newToken)\n          }\n          requests.forEach(requestItem => {\n            let {resolve, conf} = requestItem\n            if (newToken) {\n              conf.headers['Authorization'] = newToken.type + ' ' + newToken.token\n            }\n            resolve(conf)\n          })\n          requests = []\n          isRefreshing = false\n        })\n      }\n\n      // 收集需要刷新token的请求，待token刷新完毕时resolve触发\n      return new Promise(resolve => {\n        requests.push({resolve, conf: config})\n      })\n    }\n\n    // 无需刷新的token直接设置并返回\n    config.headers['Authorization'] = token.type + ' ' + token.token\n  }\n  return config\n}, error => {\n  loading && loading.close()\n  // 对请求错误做些什么\n  return Promise.reject(error)\n})\n\napi.interceptors.response.use(res => {\n  loading && loading.close()\n  let {data} = res\n  if (data.code !== 200) {\n    if (data.code === 401) {\n      Message.error('登录超时，请重新登录')\n      localStorage.removeItem('JWT_FXHOS_TOKEN')\n      global.location.reload()\n    } else if (data.code === 404) {\n      router.push('/404')\n    } else if (data.code === 422) {\n      for (const key in data.data) {\n        let err = data.data[key]\n        if (typeof err === 'string') Message.error(err)\n        else Message.error(err[0])\n        break\n      }\n    } else if (data.code === 500 && typeof data.data === 'string') {\n      Message.error(data.data)\n    } else {\n      Message.error(i18n.t('base.error'))\n    }\n  } else {\n    loading && loading.close()\n    return data.data || true\n  }\n})\n\nexport default {\n  install(Vue) {\n    Vue.api = api\n    Vue.prototype.$api = api\n  }\n}\n"]}]}